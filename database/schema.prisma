// OpenBio Prisma Schema
// Database models for inventory, experiments, and digital assets

// Prisma Client Rust - generates a Rust client
// Database URL is passed at RUNTIME when constructing PrismaClient
// Run: cargo run -p prisma-cli -- generate --schema=database/schema.prisma
generator client {
  provider = "cargo run -p prisma-cli --"
  output   = "../crates/openbio-server/src/db/prisma.rs"
}

// NOTE: prisma-client-rust (v0.6.x) uses Prisma 4/5 schema format.
// The VS Code Prisma extension may show warnings for Prisma 7 - these can be ignored.
// Database URL is passed at RUNTIME via PrismaClient::_builder().with_url()
datasource db {
  provider = "sqlite"
  // Development database - actual runtime uses user's app data folder in production
  url      = "file:../.dev/openbio.db"
}

// ============================================
// Module A: Inventory (Freezer)
// ============================================

/// Physical sample (e.g., tube, cell line, tissue, reagent, chemical)
model Sample {
  id         String  @id @default(cuid())
  externalId String? @unique // QR code or barcode
  name       String
  type       String // e.g., "cell_line", "tissue", "plasmid", "reagent", "chemical"
  metadata   String? // Free-form notes and description

  // Location tracking
  containerId  String?
  container    Container? @relation(fields: [containerId], references: [id])
  slotPosition String? // e.g., "A1", "B3" for box grids

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  experiments ExperimentSample[]
  assets      DigitalAsset[]
}

/// Container (freezer, shelf, box, rack)
model Container {
  id           String  @id @default(cuid())
  externalId   String? @unique // QR code
  name         String
  type         String // e.g., "freezer", "shelf", "box", "rack"
  layoutConfig String? // JSON for grid dimensions, slot config

  // Hierarchy
  parentId String?
  parent   Container?  @relation("ContainerHierarchy", fields: [parentId], references: [id])
  children Container[] @relation("ContainerHierarchy")

  // Contents
  samples Sample[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// Module B: Experiments & Notebooks
// ============================================

/// Equipment/Instrument in the lab
model Equipment {
  id         String  @id @default(cuid())
  externalId String? @unique // QR code
  name       String
  type       String // e.g., "sequencer", "microscope", "centrifuge", "pcr_machine"
  model      String?
  serialNumber String?

  // Location
  location String?

  // Import settings (for openbio-agent integration)
  watchFolder   String? // Folder path that agent monitors for new files
  autoImport    Boolean @default(false) // Whether auto-import is enabled
  agentStatus   String  @default("OFFLINE") // OFFLINE, ONLINE, LOCKED
  lastSyncAt    DateTime?

  // Scheduling (for booking experiments)
  bookings Experiment[]

  // Metadata
  metadata  String? // Free-form JSON for equipment-specific settings
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Research paper/reference in the library
model Paper {
  id    String @id @default(cuid())
  title String
  
  // Citation info
  authors      String? // Comma-separated or JSON array
  journal      String?
  year         Int?
  doi          String? @unique
  pmid         String? // PubMed ID
  url          String?
  
  // Content
  abstract     String?
  notes        String? // User's notes about the paper
  pdfPath      String? // Local path or S3 key to PDF
  
  // Tags/Categories
  tags         String? // JSON array of tags
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  addedBy   String?
}

/// Experiment linking samples to procedures and outputs
model Experiment {
  id          String  @id @default(cuid())
  name        String
  description String?
  status      String  @default("DRAFT") // Values: DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, FAILED

  // Scheduling (for instrument booking)
  scheduledAt DateTime?
  equipmentId String?
  equipment   Equipment? @relation(fields: [equipmentId], references: [id])

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  samples      ExperimentSample[]
  notebook     Notebook?
  assets       DigitalAsset[]
  pipelineRuns PipelineRun[]
}

/// Many-to-many: Experiment <-> Sample
model ExperimentSample {
  experimentId String
  sampleId     String
  role         String? // e.g., "input", "control", "treatment"

  experiment Experiment @relation(fields: [experimentId], references: [id])
  sample     Sample     @relation(fields: [sampleId], references: [id])

  @@id([experimentId, sampleId])
}

/// Laboratory notebook for experiment protocols and notes
model Notebook {
  id           String     @id @default(cuid())
  experimentId String     @unique
  experiment   Experiment @relation(fields: [experimentId], references: [id])

  // Content (rich text stored as JSON)
  content String @default("") // Prosemirror/TipTap JSON document

  // Metadata
  title       String  @default("Untitled Notebook")
  description String?

  // Mentions and linked entities
  mentions NotebookMention[]
  entries  NotebookEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
}

/// Entry in a notebook (timestamped note)
model NotebookEntry {
  id         String   @id @default(cuid())
  notebookId String
  notebook   Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  // Content
  content   String // Rich text JSON
  timestamp DateTime @default(now())
  author    String?

  // Attached data files from equipment imports
  attachedAssetId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// @mentions in notebooks with metadata snapshots
model NotebookMention {
  id         String   @id @default(cuid())
  notebookId String
  notebook   Notebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)

  // What was mentioned
  entityType String // "sample", "equipment", "paper"
  entityId   String // ID of the referenced entity

  // Snapshot of metadata at time of mention (preserves data if entity is deleted)
  snapshotData String // JSON snapshot of entity data

  // Position in document (for highlighting/navigation)
  position Int?

  createdAt DateTime @default(now())
}

// ============================================
// Module C & D: Digital Assets & Pipelines
// ============================================

/// Digital file (raw data, processed results, etc.)
model DigitalAsset {
  id         String  @id @default(cuid())
  filename   String
  storageKey String // S3 key or local path
  mimeType   String?
  sizeBytes  Int? // Changed from BigInt for SQLite compat
  checksum   String? // SHA256 hash

  // Lineage
  experimentId String?
  experiment   Experiment? @relation(fields: [experimentId], references: [id])
  sampleId     String?
  sample       Sample?     @relation(fields: [sampleId], references: [id])

  // Pipeline output
  pipelineRunId String?
  pipelineRun   PipelineRun? @relation(fields: [pipelineRunId], references: [id])

  // Type classification
  assetType String @default("RAW") // Values: RAW, PROCESSED, ANALYSIS, REPORT

  // Audit
  createdAt  DateTime @default(now())
  uploadedBy String?
  machineId  String? // Which instrument produced this
}

/// Pipeline execution record
model PipelineRun {
  id           String     @id @default(cuid())
  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id])

  pipelineType String // e.g., "nf-core/rnaseq"
  status       String @default("PENDING") // Values: PENDING, RUNNING, COMPLETED, FAILED, CANCELLED

  // Execution details
  startedAt   DateTime?
  completedAt DateTime?
  exitCode    Int?
  logPath     String?

  // Config used
  configJson String? // JSON string

  // Outputs
  outputs DigitalAsset[]

  createdAt DateTime @default(now())
}
