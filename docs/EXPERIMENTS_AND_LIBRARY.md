# CRITICAL: Experiments and Library Architecture

## ⚠️ READ THIS FIRST TO AVOID CONFUSION ⚠️

### The Correct Architecture (DO NOT FUCK THIS UP)

OpenBio has TWO distinct modules that are often confused:

## 1. EXPERIMENTS = THE NOTEBOOKS

**The Experiment tab IS the laboratory notebook.**

- Each `Experiment` has a `content` field that stores rich text (the notebook)
- You do NOT create a separate "Notebook" entity
- Experiments and Notebooks are THE SAME THING
- When you open an experiment, you write notes directly in it

### Database Schema

```prisma
model Experiment {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("DRAFT")
  
  // THIS IS THE NOTEBOOK CONTENT ⬇️
  content     String?  // Rich text HTML from TipTap editor
  
  // Relationships
  samples     ExperimentSample[]
  entries     ExperimentEntry[]
  mentions    ExperimentMention[]
  assets      DigitalAsset[]
}
```

### What Lives in Experiments:

- ✅ Your experimental procedures and observations
- ✅ Rich text notes written in TipTap editor
- ✅ @mentions of samples, equipment, and papers
- ✅ Timestamped entries for key events
- ✅ Links to data files generated by equipment
- ✅ Protocol deviations and unexpected results

### What Does NOT Live in Experiments:

- ❌ No separate "Notebook" model
- ❌ No `/api/notebooks` endpoint
- ❌ No "Notebooks" tab in the UI navigation

## 2. LIBRARY = YOUR PAPER BOOKSHELF

**The Library is a collection of research papers you've read.**

- Completely standalone - NOT linked to experiments
- Papers exist independently and can be @mentioned in experiments
- Think of it as your "Zotero" or "Mendeley" replacement

### Database Schema

```prisma
model Paper {
  id       String @id @default(cuid())
  title    String
  authors  String?
  journal  String?
  year     Int?
  doi      String? @unique
  pmid     String?
  url      String?
  abstract String?
  
  // THIS IS WHERE YOU TAKE NOTES ABOUT THE PAPER ⬇️
  notes    String? // Your personal comments/summary
  
  pdfPath  String? // Local PDF storage
  tags     String? // JSON array
}
```

### What Lives in Library:

- ✅ Research papers you've read
- ✅ Your notes/comments about each paper
- ✅ Citation metadata (authors, journal, DOI, etc.)
- ✅ PDF files of papers (optional)
- ✅ Tags for organization

### What Does NOT Live in Library:

- ❌ NOT linked to specific experiments by default
- ❌ NOT experimental notes (those go in experiments)
- ❌ NOT protocols (those are experiments)

## How They Work Together

### @Mention System

When writing notes in an **Experiment**, you can type `@` to mention:

- **@samples** - Physical samples from inventory
- **@equipment** - Lab instruments
- **@papers** - Papers from your library (creates a reference)

When you @mention a paper from the library in an experiment:
1. The mention links to the Paper record
2. A snapshot is saved (title, authors, year, DOI, etc.)
3. The experiment now has a citation/reference to that paper
4. But the Paper itself doesn't "belong" to the experiment

### Example Workflow

1. **Add Paper to Library:**
   - Go to "Library" tab
   - Add paper: "Smith et al. 2024 - CRISPR Methods"
   - Write your notes: "Great protocol for gRNA design. Use section 3.2"

2. **Create Experiment:**
   - Go to "Experiments" tab
   - Create experiment: "CRISPR Screen - March 2024"
   - Write in the notebook area

3. **Reference the Paper:**
   ```
   Using protocol from @Smith-2024-CRISPR-Methods
   Modified the gRNA concentration to 10mM based on their findings.
   ```

4. **The Result:**
   - Paper stays in Library (not deleted when experiment ends)
   - Experiment has a mention/snapshot of the paper
   - You can use the same paper in multiple experiments

## API Endpoints

### Experiments (with notebook content)

```
GET    /api/experiments              # List all experiments
POST   /api/experiments              # Create with name, description
GET    /api/experiments/:id          # Get with content and mentions
PATCH  /api/experiments/:id          # Update content, name, etc.
DELETE /api/experiments/:id          # Delete experiment

GET    /api/experiments/:id/entries  # Timestamped notebook entries
POST   /api/experiments/:id/entries  # Add entry

GET    /api/experiments/:id/mentions # Get all @mentions
POST   /api/experiments/:id/mentions # Create mention with snapshot

GET    /api/experiments/search-entities  # Search samples/equipment/papers for @mentions
```

### Library (standalone papers)

```
GET    /api/library           # List all papers
POST   /api/library           # Add paper
GET    /api/library/:id       # Get paper with notes
PATCH  /api/library/:id       # Update paper/notes
DELETE /api/library/:id       # Delete paper
```

## UI Navigation

```
Dashboard   - Overview stats
Freezer     - Sample inventory
Library     - Research papers bookshelf  ← Standalone
Experiments - Lab notebooks              ← This IS the notebook
Insight     - Data visualization
Equipment   - Lab instruments
Settings    - Configuration
```

## Common Mistakes (DON'T DO THESE)

### ❌ WRONG: Creating separate Notebook model

```prisma
// DON'T DO THIS!
model Notebook {
  id           String
  experimentId String
  content      String
}

model Experiment {
  id       String
  notebook Notebook?
}
```

### ✅ CORRECT: Content field in Experiment

```prisma
model Experiment {
  id      String
  name    String
  content String?  // THIS IS THE NOTEBOOK
}
```

### ❌ WRONG: Linking papers to experiments in schema

```prisma
// DON'T DO THIS!
model Paper {
  id           String
  experimentId String?  // NO! Papers are standalone
}
```

### ✅ CORRECT: Papers are standalone, linked via mentions

```prisma
model Paper {
  id    String
  notes String?  // User's notes about the paper
}

model ExperimentMention {
  experimentId String
  entityType   String  // "paper"
  entityId     String  // Links to Paper.id via mention
  snapshotData String  // Snapshot of paper at mention time
}
```

## Frontend Components

### ExperimentsPage

- Shows list of experiments in sidebar
- Main area shows the TipTap editor
- Editor content is the experiment's `content` field
- Type `@` to mention samples/equipment/papers

### LibraryPage

- Shows list of papers in sidebar
- Main area shows paper details (abstract, citation, etc.)
- Shows your notes about the paper
- Papers can be @mentioned in experiments

### DO NOT CREATE:

- ❌ NotebookPage (experiments ARE the notebooks)
- ❌ `/api/notebooks` routes
- ❌ "Notebooks" navigation tab

## The Mental Model

Think of it like this:

**Experiments** = Google Docs for lab work
- You write directly in the experiment
- The experiment has the text content
- You can @mention things while writing

**Library** = Zotero for papers
- Standalone collection
- Papers persist independently
- Can be referenced from experiments via @mentions

## Summary

1. **Experiments tab** = The laboratory notebook with rich text editor
2. **Library tab** = Your research paper collection
3. Papers from library can be @mentioned in experiments
4. Do NOT create separate Notebook model/routes/UI
5. Experiment.content field stores the notebook text
6. Paper.notes field stores your notes about papers

**If you ever think "should I create a Notebook model?"** → NO. The experiment IS the notebook.

**If you ever think "should papers link to experiments?"** → NO. Papers are standalone. Use @mentions for references.
